<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<#include "../commons/imports.html"/>
</head>
<body class="layui-layout-body">
	<div class="layui-layout layui-layout-admin">
		<#include "../commons/header.html"/> <#include
		"../commons/sider.html"/>
		<div class="layui-body">
			<blockquote class="layui-elem-quote">
				<div class="layui-inline">
					系统配置：
					<br>HMAC摘要算法：${hmacAlg!}
					<br>HMAC摘要秘钥：${hmacSecretKey!}
				</div>
			</blockquote>
			<fieldset class="layui-elem-field layui-field-title" style="margin-top: 3px;"></fieldset>
			
			<table class="table table-hover">
				<tbody>
					<tr>
						<td width="100" style="padding: 5px 0;"><label
							class="layui-form-label">参数1：</label></td>
						<td width="300"><input id="parameter1" name="parameter1" class="layui-input" type="text"></td>
						<td width="100" style="padding: 5px 0;"><label
							class="layui-form-label">参数2：</label></td>
						<td width="300"><input id="parameter2" name="parameter2" class="layui-input" type="text"></td>
					</tr>
					<tr>
						<td width="100" style="padding: 5px 0;"></td>
						<td width="300">
							<a class="layui-btn layui-btn-mini" onclick="createHmac()">
							<i class="layui-icon">&#xe642;</i> 生成摘要</a>
						</td>
					</tr>
				</tbody>
			</table>
			<blockquote class="layui-elem-quote">
				<div id="hamc_create_div" style="display: none;">
					<br>参数1(parameter1)：<span id="parameter1_value"></span>
					<br>参数2(parameter2)：<span id="parameter2_value"></span>
					<br>时间戳(hmac_timestamp)：<span id="hmac_timestamp_value"></span>
					<br>用户标识(hmac_app_id)：<span id="hmac_app_id_value"></span>
					<br>进行摘要的内容：<span id="base_string_value"></span>
					<br>
					<div style="width: 400px;" class="layui-input-inline">
					 摘要：<input id="hmac_digest_value" name="hmac_digest" class="layui-input " type="text"/>
					</div>
				</div>
			</blockquote>
			<a class="layui-btn layui-btn-mini" onclick="hmacRequest()">
							<i class="layui-icon">&#xe642;</i> 请求接口</a>
							<br><br>
							如果想测试认证不通过的情况，可以修改参数或者摘要的值
			<!-- 内容主体区域 -->
		</div>
		<#include "../commons/footer.html"/>
	</div>
	<script type="text/javascript" src="${ctx}/assets/js/main.js"></script>
		<script>
		function createHmac() {
			var parameter1 = $("#parameter1").val();
			var parameter2 = $("#parameter2").val();
			if(parameter1 == ''){
				layer.alert('参数1不能为空',{icon:2, title:'错误'});
				return;
			}
			if(parameter2 == ''){
				layer.alert('参数2不能为空',{icon:2, title:'错误'});
				return;
			}
			var hmac_timestamp =  Date.parse(new Date());
			var hmac_app_id =  '${Session.shiro_current_user_account!}';
			$("#parameter1_value").html(parameter1);
			$("#parameter2_value").html(parameter2);
			$("#hmac_timestamp_value").html(hmac_timestamp);
			$("#hmac_app_id_value").html(hmac_app_id);
			var base_string = parameter1+parameter2+hmac_app_id+hmac_timestamp
			$("#base_string_value").html(base_string);
			var hmac_digest = "";
			ajaxPost("${ctx}/rest/hmac_digest",{
				base_string:base_string
			},function(result) {
				if(result.respond == 1){
					hmac_digest = result.hmac_digest;
					$("#hmac_digest_value").val(hmac_digest);
				}
			});
			$("#hamc_create_div").show();
		}
		
		
		function hmacRequest() {
			var hmac_digest = $("#hmac_digest_value").val();
			if(hmac_digest == ''){
				layer.alert('请先生成摘要',{icon:2, title:'错误'});
				return;
			}
			var parameter1 = $("#parameter1").val();
			var parameter2 = $("#parameter2").val();
			var hmac_app_id =  '${Session.shiro_current_user_account!}';
			var hmac_timestamp = $("#hmac_timestamp_value").html();
			
			ajaxPost('${ctx}/rest/test_post',{
				parameter1:parameter1
				,parameter2:parameter2
				,hmac_app_id:hmac_app_id
				,hmac_timestamp:hmac_timestamp
				,hmac_digest:hmac_digest
			},function(result) {
				if(result.respond==1){
					layer.alert(result.message,{icon:1, title:'成功'});
				}else{
					layer.alert(result.message,{icon:2, title:'失败'});
				}
			})
		}		
	</script>
</body>
</html>